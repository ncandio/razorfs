# RAZORFS Docker Test Infrastructure - Windows Workflow

**Purpose**: Continuous filesystem testing, benchmarking, and graph generation with Windows Desktop sync

**Status**: ✅ Active - Dynamic Testing Environment
**Windows Sync**: `C:\Users\liber\Desktop\Testing-Razor-FS`
**Last Updated**: 2025-10-29

---

## 🎯 Overview

The RAZORFS Docker test infrastructure provides a **dynamic, continuous testing environment** that:

1. **Continuously validates** filesystem integrity across commits
2. **Automatically generates** performance graphs tagged with commit IDs
3. **Syncs results** to Windows Desktop for easy access and sharing
4. **Compares performance** against ext4, ZFS, and ReiserFS
5. **Enables rapid iteration** with isolated test environments

**Key Feature**: All graphs in the main README are generated by this infrastructure and automatically tagged with the latest commit SHA for traceability.

---

## 📊 Graph Tagging System

### How It Works

Every graph generated includes a tag showing:
- **Commit SHA**: Short hash (e.g., `7357250`)
- **Generation Date**: When the graph was created
- **Example**: `Generated: 2025-10-29 [7357250]`

This ensures that:
- ✅ README graphs reflect the **exact codebase version**
- ✅ Performance changes are **traceable** to specific commits
- ✅ Benchmarks are **reproducible** at any commit
- ✅ Historical comparisons are **accurately documented**

### Generating Tagged Graphs

```bash
# Generate all README graphs with current commit tag
./generate_tagged_graphs.sh
```

This creates 5 professional graphs in `readme_graphs/`:
1. `comprehensive_performance_radar.png` - 8-metric radar chart
2. `ologn_scaling_validation.png` - Lookup complexity proof
3. `scalability_heatmap.png` - Performance score matrix
4. `compression_effectiveness.png` - Space savings comparison
5. `memory_numa_analysis.png` - NUMA locality analysis

**All graphs automatically sync to Windows at**: `C:\Users\liber\Desktop\Testing-Razor-FS\readme_graphs\`

---

## 🪟 Windows Environment Setup

### Prerequisites

**Software Required:**
- ✅ Windows 10/11 (Build 19041+)
- ✅ WSL2 enabled
- ✅ Docker Desktop for Windows (latest)
- ✅ Git for Windows (optional, for manual sync)

### Windows Directory Structure

```
C:\Users\liber\Desktop\Testing-Razor-FS\
├── benchmarks/                    # Benchmark results and data
│   ├── BENCHMARK_REPORT_*.md      # Timestamped reports
│   ├── data/                      # Raw benchmark data
│   │   ├── compression_*.dat
│   │   ├── recovery_*.dat
│   │   ├── numa_*.dat
│   │   └── persistence_*.dat
│   ├── graphs/                    # Generated PNG graphs
│   │   ├── compression_comparison.png
│   │   ├── recovery_comparison.png
│   │   ├── numa_comparison.png
│   │   └── persistence_verification.png
│   ├── reports/                   # Historical reports
│   └── versioned_results/         # Commit-tagged results
│
├── readme_graphs/                 # README documentation graphs
│   ├── comprehensive_performance_radar.png
│   ├── ologn_scaling_validation.png
│   ├── scalability_heatmap.png
│   ├── compression_effectiveness.png
│   └── memory_numa_analysis.png
│
├── logs/                          # Test execution logs
│   ├── docker_build_*.log
│   ├── benchmark_run_*.log
│   └── sync_*.log
│
└── docker/                        # Docker build artifacts
    ├── Dockerfile
    └── docker-compose.yml
```

### WSL2 → Windows Sync Path

**WSL2 Path**: `/home/nico/WORK_ROOT/razorfs/`
**Windows Path**: `C:\Users\liber\Desktop\Testing-Razor-FS`
**WSL2 Mount Point**: `/mnt/c/Users/liber/Desktop/Testing-Razor-FS`

```bash
# From WSL2, sync results to Windows
cp -r benchmarks/ /mnt/c/Users/liber/Desktop/Testing-Razor-FS/
cp -r readme_graphs/ /mnt/c/Users/liber/Desktop/Testing-Razor-FS/
```

This is automatically handled by the benchmark scripts.

---

## 🐳 Docker Infrastructure

### Architecture

```
┌────────────────────────────────────────────────────────────────┐
│                    Windows 11 Desktop                          │
│                                                                │
│  📁 C:\Users\liber\Desktop\Testing-Razor-FS\                  │
│     ├── benchmarks/        ← Continuous updates                │
│     ├── readme_graphs/     ← Tagged with commit SHA            │
│     └── logs/              ← Test execution logs               │
└────────────────────────────────────────────────────────────────┘
                              ▲
                              │ Auto-sync
                              │
┌────────────────────────────────────────────────────────────────┐
│                       WSL2 (Ubuntu)                            │
│                                                                │
│  ┌──────────────────────────────────────────────────────┐    │
│  │  RAZORFS Test Harness                                │    │
│  │  • Native execution                                   │    │
│  │  • FUSE3 filesystem                                   │    │
│  │  • Shared memory (/dev/shm)                           │    │
│  │  • Git commit tagging                                 │    │
│  └──────────────────────────────────────────────────────┘    │
│                              │                                 │
│  ┌──────────────────────────────────────────────────────┐    │
│  │  Docker Desktop (WSL2 Backend)                       │    │
│  │                                                       │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │    │
│  │  │ ext4 Test   │  │ ZFS Test    │  │ ReiserFS    │ │    │
│  │  │ Container   │  │ Container   │  │ Container   │ │    │
│  │  │ (Alpine)    │  │ (Ubuntu)    │  │ (Ubuntu)    │ │    │
│  │  └─────────────┘  └─────────────┘  └─────────────┘ │    │
│  │  • Privileged mode for fs creation                  │    │
│  │  • Loop devices for disk images                     │    │
│  │  • Volume mounts for test data                      │    │
│  └──────────────────────────────────────────────────────┘    │
│                              │                                 │
│  ┌──────────────────────────────────────────────────────┐    │
│  │  Graph Generation (Gnuplot)                          │    │
│  │  • Processes benchmark data                          │    │
│  │  • Creates tagged PNG graphs                         │    │
│  │  • Generates markdown reports                        │    │
│  └──────────────────────────────────────────────────────┘    │
└────────────────────────────────────────────────────────────────┘
```

### Dockerfile Details

The RAZORFS Docker image includes:

```dockerfile
FROM ubuntu:22.04

# Build toolchain
- gcc, make, pkg-config
- FUSE3 development libraries
- zlib compression library

# Testing tools
- gnuplot (graph generation)
- python3 + numpy + matplotlib
- bc (bash calculator)
- curl, wget (test file downloads)
- linux-perf (performance profiling)

# RAZORFS compiled binary
- Built from source
- All dependencies included
```

**Image Size**: ~500MB
**Build Time**: ~2 minutes (first build)
**Startup Time**: <5 seconds

---

## 🚀 Quick Start Guide

### 1. Initial Setup (One-Time)

```bash
# On Windows: Open PowerShell as Administrator

# Enable WSL2 (if not already enabled)
wsl --install

# Install Ubuntu from Microsoft Store
# Open Ubuntu and set username/password

# Install Docker Desktop for Windows
# Download from: https://www.docker.com/products/docker-desktop

# Configure Docker Desktop
# Settings → General → "Use the WSL 2 based engine" ✓
# Settings → Resources → WSL Integration → Enable Ubuntu ✓
```

### 2. Create Windows Test Directory

```powershell
# From PowerShell
New-Item -ItemType Directory -Path "C:\Users\liber\Desktop\Testing-Razor-FS" -Force
New-Item -ItemType Directory -Path "C:\Users\liber\Desktop\Testing-Razor-FS\benchmarks" -Force
New-Item -ItemType Directory -Path "C:\Users\liber\Desktop\Testing-Razor-FS\readme_graphs" -Force
New-Item -ItemType Directory -Path "C:\Users\liber\Desktop\Testing-Razor-FS\logs" -Force
```

### 3. WSL2 Setup

```bash
# From Ubuntu WSL2
cd /home/nico/WORK_ROOT/razorfs

# Install dependencies
sudo apt-get update
sudo apt-get install -y \
    build-essential \
    pkg-config \
    libfuse3-dev \
    zlib1g-dev \
    gnuplot \
    bc \
    wget \
    docker.io

# Add user to docker group
sudo usermod -aG docker $USER
newgrp docker

# Verify Docker works
docker run hello-world
```

### 4. Build RAZORFS

```bash
cd /home/nico/WORK_ROOT/razorfs
make clean && make
```

### 5. Run First Benchmark

```bash
# Full benchmark suite (generates all graphs)
./tests/docker/benchmark_filesystems.sh

# Or just generate README graphs
./generate_tagged_graphs.sh
```

**Results automatically appear in**: `C:\Users\liber\Desktop\Testing-Razor-FS\`

---

## 📋 Common Workflows

### Workflow 1: Daily Development Testing

**Use Case**: You made code changes and want to verify performance

```bash
# 1. Make your changes to RAZORFS code
vim src/nary_tree_mt.c

# 2. Rebuild
make clean && make

# 3. Run quick benchmark (no Docker, RAZORFS only)
./tests/shell/razorfs-only-benchmark.sh

# 4. If satisfied, run full comparison
./tests/docker/benchmark_filesystems.sh

# 5. Commit changes
git add .
git commit -m "perf: optimize lookup path"

# 6. Regenerate README graphs with new commit tag
./generate_tagged_graphs.sh

# 7. Check results on Windows Desktop
# Open: C:\Users\liber\Desktop\Testing-Razor-FS\readme_graphs\
```

**Time**: ~5 minutes (quick) or ~15 minutes (full)

### Workflow 2: Before Merging PR

**Use Case**: Ensure no performance regressions before merging

```bash
# 1. Switch to PR branch
git checkout feature/my-optimization

# 2. Full benchmark suite
./tests/docker/benchmark_filesystems.sh

# 3. Compare against main branch
git checkout main
./tests/docker/benchmark_filesystems.sh

# 4. Side-by-side comparison in Windows
# Open both reports in:
# C:\Users\liber\Desktop\Testing-Razor-FS\benchmarks\

# 5. If performance improved, merge PR
git checkout feature/my-optimization
git merge main
```

**Time**: ~30 minutes (two full runs)

### Workflow 3: Generating Documentation Graphs

**Use Case**: Update README with latest performance data

```bash
# 1. Ensure you're on the latest commit
git pull origin main

# 2. Generate all README graphs with commit tag
./generate_tagged_graphs.sh

# 3. Graphs are created in readme_graphs/ and synced to Windows

# 4. Copy to README location if needed
cp readme_graphs/*.png docs/images/

# 5. Commit updated graphs
git add readme_graphs/ docs/images/
git commit -m "docs: update performance graphs [7357250]"
git push
```

**Time**: ~2 minutes

### Workflow 4: Continuous Integration Testing

**Use Case**: Automated testing on every commit (CI/CD)

```yaml
# .github/workflows/benchmark.yml
name: Performance Benchmarks

on: [push, pull_request]

jobs:
  benchmark:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse3-dev zlib1g-dev gnuplot

      - name: Build RAZORFS
        run: make clean && make

      - name: Run benchmarks
        run: ./generate_tagged_graphs.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: performance-graphs
          path: readme_graphs/
```

**Time**: ~10 minutes per CI run

---

## 🔧 Advanced Usage

### Custom Benchmark Configuration

Edit `tests/docker/benchmark_filesystems.sh`:

```bash
# Modify test parameters
TEST_FILE_SIZE="10M"           # Default: 1MB git archive
TEST_ITERATIONS=5               # Default: 3
ENABLE_PROFILING=true          # Default: false
OUTPUT_FORMAT="markdown"        # Options: markdown, json, html

# Add new filesystems
RUN_BTRFS_TESTS=true           # Default: false
RUN_F2FS_TESTS=true            # Default: false

# Windows sync location
WINDOWS_SYNC_DIR="/mnt/c/Users/liber/Desktop/Testing-Razor-FS"
```

### Running Individual Tests

```bash
# Compression test only
./tests/docker/test_compression.sh

# Recovery test only
./tests/docker/test_recovery.sh

# NUMA test only
./tests/docker/test_numa.sh

# Persistence test only
./tests/docker/test_persistence.sh
```

### Docker Compose for Complex Scenarios

```yaml
# docker-compose.yml
version: '3.8'

services:
  razorfs-test:
    build: .
    privileged: true
    volumes:
      - /dev/shm:/dev/shm
      - ./benchmarks:/app/benchmarks
      - /mnt/c/Users/liber/Desktop/Testing-Razor-FS:/windows-sync
    environment:
      - TEST_MODE=full
      - SYNC_TO_WINDOWS=true
    command: bash -c "./tests/docker/benchmark_filesystems.sh"

  ext4-test:
    image: ubuntu:22.04
    privileged: true
    volumes:
      - ./test-data:/data
    command: bash -c "mkfs.ext4 /dev/loop0 && mount /dev/loop0 /mnt"

  zfs-test:
    image: ubuntu:22.04
    privileged: true
    volumes:
      - ./test-data:/data
    command: bash -c "zpool create testpool /dev/loop0"
```

```bash
# Run all tests in parallel
docker-compose up

# Run specific test
docker-compose run razorfs-test

# Clean up
docker-compose down -v
```

### Profiling and Performance Analysis

```bash
# Run with perf profiling
sudo perf record -g ./tests/docker/benchmark_filesystems.sh

# Analyze hotspots
sudo perf report

# Generate flamegraph
git clone https://github.com/brendangregg/FlameGraph
sudo perf script | ./FlameGraph/stackcollapse-perf.pl | \
  ./FlameGraph/flamegraph.pl > /mnt/c/Users/liber/Desktop/Testing-Razor-FS/flamegraph.svg
```

---

## 🐛 Troubleshooting

### Issue 1: Docker Desktop Not Running

**Symptom**:
```
Cannot connect to the Docker daemon. Is the docker daemon running?
```

**Solution**:
```powershell
# Windows: Start Docker Desktop
# Open Docker Desktop from Start Menu
# Wait for "Docker Desktop is running" in system tray

# Or restart from PowerShell
Stop-Process -Name "Docker Desktop"
Start-Process "C:\Program Files\Docker\Docker\Docker Desktop.exe"
```

### Issue 2: WSL2 Can't Access Windows Files

**Symptom**:
```
ls: cannot access '/mnt/c/Users/liber/Desktop/Testing-Razor-FS': No such file or directory
```

**Solution**:
```bash
# Check if C: drive is mounted
ls /mnt/c/

# If not mounted, restart WSL
# From PowerShell:
wsl --shutdown
wsl

# Create directory if it doesn't exist
mkdir -p /mnt/c/Users/liber/Desktop/Testing-Razor-FS
```

### Issue 3: Permission Denied in Windows Sync

**Symptom**:
```
cp: cannot create regular file '/mnt/c/...': Permission denied
```

**Solution**:
```bash
# Fix WSL2 permissions in /etc/wsl.conf
sudo tee /etc/wsl.conf << EOF
[automount]
enabled = true
options = "metadata,umask=22,fmask=11"
EOF

# Restart WSL from PowerShell
wsl --shutdown
wsl
```

### Issue 4: Graphs Not Generating

**Symptom**:
```
gnuplot: command not found
```

**Solution**:
```bash
sudo apt-get update
sudo apt-get install -y gnuplot gnuplot-qt
```

### Issue 5: Docker Build Fails

**Symptom**:
```
ERROR: failed to solve: dockerfile parse error
```

**Solution**:
```bash
# Rebuild Docker image from scratch
docker build --no-cache -t razorfs-test .

# If still fails, check Dockerfile syntax
cat Dockerfile | head -20

# Clear Docker cache
docker system prune -a
```

### Issue 6: Slow Docker Performance on Windows

**Symptom**: Docker tests run very slowly (>30 minutes)

**Solution**:
```bash
# 1. Allocate more resources in Docker Desktop
# Settings → Resources → Advanced
# Memory: 8GB (minimum 4GB)
# CPUs: 4 (minimum 2)
# Disk: 100GB

# 2. Enable WSL2 integration
# Settings → Resources → WSL Integration
# Enable integration with Ubuntu

# 3. Use WSL2 native storage (not /mnt/c/)
cd /home/nico/WORK_ROOT/razorfs  # Much faster
# Instead of:
cd /mnt/c/Users/...               # Very slow
```

---

## 📊 Understanding the Results

### Benchmark Report Structure

```markdown
# RAZORFS Benchmark Report - 2025-10-29 [7357250]

## Test Environment
- Commit: 7357250
- Platform: WSL2 Ubuntu 22.04
- Docker: Desktop 4.25.0
- CPU: 8 cores
- RAM: 16GB

## Performance Comparison

### 1. Compression Efficiency
| Filesystem | Disk Usage | Compression Ratio | Space Saved |
|------------|------------|-------------------|-------------|
| RAZORFS    | 5.2 MB     | 2.5:1             | 60%         |
| ext4       | 10.0 MB    | 1.0:1 (none)      | 0%          |
| ZFS        | 8.5 MB     | 1.5:1             | 15%         |

### 2. Recovery Time
| Filesystem | Crash Recovery | Data Integrity |
|------------|----------------|----------------|
| RAZORFS    | <1ms (instant) | 100%           |
| ext4       | 150ms          | 100%           |
| ZFS        | 200ms          | 100%           |

### 3. NUMA Performance
| Filesystem | NUMA Score | Access Latency |
|------------|------------|----------------|
| RAZORFS    | 95/100     | 45ns           |
| ext4       | 60/100     | 120ns          |

### 4. Persistence Verification
| Filesystem | Write→Unmount→Remount | MD5 Match |
|------------|----------------------|-----------|
| RAZORFS    | ✅ Pass               | ✅ Yes     |
| ext4       | ✅ Pass               | ✅ Yes     |
| ZFS        | ✅ Pass               | ✅ Yes     |
```

### Reading the Graphs

**1. Radar Chart** (comprehensive_performance_radar.png)
- **Center (0)**: Worst performance
- **Edge (100)**: Best performance
- **Blue area**: RAZORFS performance envelope
- **Larger area = Better overall performance**

**2. O(log n) Plot** (ologn_scaling_validation.png)
- **X-axis**: Number of files (log scale)
- **Y-axis**: Lookup time (microseconds)
- **Flat line = O(1)**, **Gentle slope = O(log n)**, **Steep = O(n)**
- **RAZORFS should show log-linear growth**

**3. Heatmap** (scalability_heatmap.png)
- **Green**: Good performance (80-100)
- **Yellow**: Moderate (50-79)
- **Red**: Poor (<50)
- **Quick visual comparison across all metrics**

---

## 🔄 Integration with CI/CD

### GitHub Actions Integration

The Docker infrastructure integrates with GitHub Actions:

```yaml
# .github/workflows/docker-benchmark.yml
name: Docker Benchmark Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday

jobs:
  benchmark:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Docker image
        run: docker build -t razorfs-test .

      - name: Run benchmark suite
        run: |
          docker run --privileged \
            -v $(pwd)/benchmarks:/app/benchmarks \
            razorfs-test \
            bash -c "./tests/docker/benchmark_filesystems.sh"

      - name: Generate tagged graphs
        run: ./generate_tagged_graphs.sh

      - name: Upload results
        uses: actions/upload-artifact@v3
        with:
          name: benchmark-results-${{ github.sha }}
          path: |
            benchmarks/
            readme_graphs/

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('benchmarks/BENCHMARK_REPORT_*.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
```

---

## 📚 Additional Resources

### Documentation
- [Main README](README.md) - Project overview
- [Benchmark Details](tests/docker/BENCHMARKS_README.md) - Test methodology
- [Phase 7 Plan](PHASE7_PLAN.md) - Production hardening roadmap

### Scripts
- `generate_tagged_graphs.sh` - Generate all README graphs
- `tests/docker/benchmark_filesystems.sh` - Full benchmark suite
- `tests/shell/razorfs-only-benchmark.sh` - Quick RAZORFS-only tests

### Windows Shortcuts

Create desktop shortcuts for quick access:

**Benchmark Results** (shortcut to): `C:\Users\liber\Desktop\Testing-Razor-FS\benchmarks\`
**README Graphs** (shortcut to): `C:\Users\liber\Desktop\Testing-Razor-FS\readme_graphs\`
**Latest Report** (shortcut to): `C:\Users\liber\Desktop\Testing-Razor-FS\benchmarks\BENCHMARK_REPORT_*.md`

---

## 🎯 Best Practices

1. **✅ Always tag graphs** - Run `generate_tagged_graphs.sh` after significant changes
2. **✅ Commit results** - Include benchmark data in version control for historical tracking
3. **✅ Use versioned folders** - Keep old results for comparison
4. **✅ Clean Docker regularly** - `docker system prune -a` to free space
5. **✅ Sync to Windows** - Keep Windows directory up-to-date for easy sharing
6. **✅ Document changes** - Add notes to benchmark reports explaining performance changes

---

**Last Updated**: 2025-10-29
**Maintained by**: RAZORFS Development Team
**Questions?**: Create an issue at https://github.com/ncandio/razorfs/issues
