# RAZOR Filesystem Persistent Kernel Module Makefile

obj-m += razorfs_persistent.o
razorfs_persistent-objs := razorfs_persistent_kernel.o

# Kernel build directory
KDIR := /lib/modules/$(shell uname -r)/build

# Current directory
PWD := $(shell pwd)

# Compiler flags
ccflags-y := -O3 -march=native -DRAZOR_PERSISTENT -DDEBUG
ccflags-y += -Wno-declaration-after-statement

# Default target
default:
	$(MAKE) -C $(KDIR) M=$(PWD) modules

# Clean target
clean:
	$(MAKE) -C $(KDIR) M=$(PWD) clean
	rm -f *.order *.symvers

# Install target
install: default
	$(MAKE) -C $(KDIR) M=$(PWD) modules_install
	depmod -a

# Load module
load: default
	sudo insmod razorfs_persistent.ko debug_level=1 auto_snapshot=1

# Unload module  
unload:
	sudo rmmod razorfs_persistent || true

# Reload module
reload: unload load

# Test mount
mount_test:
	sudo mkdir -p /mnt/razorfs_test
	sudo mount -t razorfs none /mnt/razorfs_test
	sudo chown $(USER):$(USER) /mnt/razorfs_test

# Test unmount
unmount_test:
	sudo umount /mnt/razorfs_test || true
	sudo rmdir /mnt/razorfs_test || true

# Full test cycle
test: reload mount_test
	@echo "RAZOR filesystem mounted at /mnt/razorfs_test"
	@echo "Test with: echo 'Hello RAZOR!' > /mnt/razorfs_test/test.txt"
	@echo "Unmount with: make unmount_test"

# Show module info
info:
	modinfo razorfs_persistent.ko

# Show dmesg output
dmesg:
	dmesg | tail -20 | grep razorfs

.PHONY: default clean install load unload reload mount_test unmount_test test info dmesg