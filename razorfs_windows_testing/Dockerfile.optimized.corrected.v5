# Optimized RazorFS Testing Dockerfile - Corrected Version v5 (Ultimate Debug)
# Tests the new O(log n) performance improvements

FROM ubuntu:22.04
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC
ENV DOCKER_ENV=true

# Install dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    gcc \
    g++ \
    make \
    libfuse3-dev \
    fuse3 \
    e2fsprogs \
    btrfs-progs \
    reiserfsprogs \
    python3 \
    python3-pip \
    python3-matplotlib \
    python3-pandas \
    python3-seaborn \
    time \
    procps \
    util-linux \
    pkg-config \
    && rm -rf /var/lib/apt/lists/*

# Configure FUSE
RUN echo 'user_allow_other' >> /etc/fuse.conf

# Create directories
RUN mkdir -p /results /mnt/ext4_test /mnt/btrfs_test /mnt/reiserfs_test /tmp/razor_mount

# Debug: Check root directory before copying
RUN echo "=== BEFORE COPY: Checking root directory ===" && \
    ls -la / && \
    echo "=== Checking current directory ===" && \
    pwd

# Set working directory
WORKDIR /razor_repo

# Debug: Check working directory
RUN echo "=== AFTER WORKDIR: Checking current directory ===" && \
    pwd && \
    ls -la . || echo "Directory is empty"

# Copy the entire repository
COPY . /razor_repo/

# Debug: Check what was copied step by step
RUN echo "=== AFTER COPY: Checking current directory ===" && \
    pwd && \
    echo "=== AFTER COPY: Directory contents ===" && \
    ls -la && \
    echo "=== AFTER COPY: Checking for Makefile ===" && \
    if [ -f "Makefile" ]; then \
        echo "Makefile found:" && \
        ls -la Makefile; \
    else \
        echo "ERROR: Makefile NOT found"; \
        echo "=== Let's check what files ARE there ===" && \
        find . -name "Makefile" -type f && \
        echo "=== Let's check the full directory structure ===" && \
        find . -type f | head -20; \
        exit 1; \
    fi && \
    echo "=== AFTER COPY: Checking src directory ===" && \
    if [ -d "src" ]; then \
        ls -la src/; \
    else \
        echo "ERROR: src directory NOT found"; \
        exit 1; \
    fi && \
    echo "=== AFTER COPY: Checking tools directory ===" && \
    if [ -d "tools" ]; then \
        ls -la tools/; \
    else \
        echo "ERROR: tools directory NOT found"; \
        exit 1; \
    fi && \
    echo "=== AFTER COPY: Checking fuse directory ===" && \
    if [ -d "fuse" ]; then \
        ls -la fuse/; \
    else \
        echo "ERROR: fuse directory NOT found"; \
        exit 1; \
    fi

# Install Python dependencies
RUN pip3 install pandas matplotlib seaborn

# Build optimized RazorFS using explicit paths
RUN echo "Building RazorFS core library..." && \
    make -f /razor_repo/Makefile -C /razor_repo clean && \
    make -f /razor_repo/Makefile -C /razor_repo userspace && \
    echo "Building FUSE implementation..." && \
    make -C /razor_repo/fuse clean && \
    make -C /razor_repo/fuse all && \
    echo "RazorFS built successfully" && \
    echo "Build verification:" && \
    ls -la /razor_repo/librazer.a /razor_repo/razorfsck /razor_repo/fuse/razorfs_fuse

# Set entrypoint
ENTRYPOINT ["/razor_repo/razorfs_windows_testing/optimized_filesystem_comparison.sh"]