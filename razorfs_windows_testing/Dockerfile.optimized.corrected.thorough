# Optimized RazorFS Testing Dockerfile - Thorough Debug Version
# Tests the new O(log n) performance improvements

FROM ubuntu:22.04
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC
ENV DOCKER_ENV=true

# Install dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    gcc \
    g++ \
    make \
    libfuse3-dev \
    fuse3 \
    e2fsprogs \
    btrfs-progs \
    python3 \
    python3-pip \
    python3-matplotlib \
    python3-pandas \
    python3-seaborn \
    time \
    procps \
    util-linux \
    pkg-config \
    findutils \
    && rm -rf /var/lib/apt/lists/*

# Configure FUSE
RUN echo 'user_allow_other' >> /etc/fuse.conf

# Create directories
RUN mkdir -p /results /mnt/ext4_test /mnt/btrfs_test /tmp/razor_mount

# Set working directory
WORKDIR /razor_repo

# Copy the entire repository
COPY . /razor_repo/

# Thorough debug: Check what was actually copied
RUN echo "=== THOROUGH DEBUG: Checking what was copied ===" && \
    echo "Current directory:" && \
    pwd && \
    echo "=== All files and directories in current directory ===" && \
    ls -la && \
    echo "=== Searching for any Makefiles in the entire copied directory ===" && \
    find . -name "Makefile" -type f 2>/dev/null || echo "No Makefiles found" && \
    echo "=== Searching for any fuse directories in the entire copied directory ===" && \
    find . -name "fuse" -type d 2>/dev/null || echo "No fuse directories found" && \
    echo "=== Searching for any src directories in the entire copied directory ===" && \
    find . -name "src" -type d 2>/dev/null || echo "No src directories found" && \
    echo "=== Searching for any tools directories in the entire copied directory ===" && \
    find . -name "tools" -type d 2>/dev/null || echo "No tools directories found" && \
    echo "=== Checking if we're in the right directory ===" && \
    if [ -f "../Makefile" ]; then echo "Makefile found in parent directory"; fi && \
    if [ -d "../fuse" ]; then echo "fuse directory found in parent directory"; fi && \
    echo "=== Checking if we're in a subdirectory ===" && \
    echo "Full path:" && \
    pwd && \
    echo "Parent directory contents:" && \
    ls -la .. && \
    echo "=== End of thorough debug ==="

# Install Python dependencies
RUN pip3 install pandas matplotlib seaborn

# Build optimized RazorFS with adaptive path detection
RUN echo "=== Building RazorFS with adaptive path detection ===" && \
    # First, try to find where the files actually are \
    MAKEFILE_PATH=$(find . -name "Makefile" -type f 2>/dev/null | head -1) && \
    FUSE_DIR=$(find . -name "fuse" -type d 2>/dev/null | head -1) && \
    echo "Found Makefile at: $MAKEFILE_PATH" && \
    echo "Found fuse directory at: $FUSE_DIR" && \
    if [ -n "$FUSE_DIR" ]; then \
        echo "Building FUSE implementation from: $FUSE_DIR" && \
        cd "$FUSE_DIR" && \
        make clean && \
        make all && \
        cd - && \
        echo "✅ FUSE implementation built successfully"; \
    elif [ -n "$MAKEFILE_PATH" ]; then \
        MAKEFILE_DIR=$(dirname "$MAKEFILE_PATH") && \
        echo "Building with Makefile from: $MAKEFILE_DIR" && \
        cd "$MAKEFILE_DIR" && \
        make clean && \
        make userspace && \
        cd - && \
        echo "✅ Core library built successfully"; \
    else \
        echo "❌ Cannot build - neither fuse directory nor Makefile found anywhere" && \
        exit 1; \
    fi